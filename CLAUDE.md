# CLAUDE.md

このファイルは、このリポジトリで Claude Code が作業するときの運用ガイドです。

## このファイルの目的

- 実装時の判断基準と作業ルールを短時間で確認できるようにする
- コード変更時に守るべき原則を明確化する
- `*.md` で意図（何を実現したいか）を管理し、コードで実装事実（どう実装したか）を管理する

## プロジェクト概要

Snotra は Windows 専用のキーボードランチャーです。バックエンドは Rust（Tauri v2）、フロントエンドは SolidJS + TypeScript で構築しています。システムトレイ/グローバルホットキー/IME などの Windows 固有機能は `windows` クレートで直接実装しています。グローバルホットキー（既定: `Alt+Q`）で検索ウィンドウを表示し、検索と起動を行います。

## ビルド・実行コマンド

```bash
cargo test -p snotra-core        # ユニットテスト（80テスト）
cargo check -p snotra            # Rustバックエンド型チェック
cargo clippy -p snotra-core -p snotra  # lint チェック
npx vite build                   # フロントエンドビルド
npm run tauri dev                # 開発実行（ホットリロード付き）
npm run tauri build              # リリースビルド
```

## 3層分担（責務分離）

- 第1層（意図管理）: `SPEC.md` と `CLAUDE.md`
- 第2層（実装事実）: `snotra-core/src/*.rs`, `src-tauri/src/*.rs`, `ui/src/**`
- 第3層（整合運用）: 挙動変更を伴う変更では、意図（`SPEC.md`）と実装を同時に整合させる

### 不一致時の扱い

- まず「バグ」か「仕様変更」かを判定する
- バグの場合: `SPEC.md` の意図に合わせてコードを修正する
- 仕様変更の場合: 先に `SPEC.md` → コード → `CLAUDE.md` の順に更新する

## ワークフロー原則

- ユーザーが具体的な計画や修正指示を既に提示している場合、プランモードや過度な探索に入らず即座に実装する
- 不明点がある場合は、1つの焦点を絞った質問をしてから実装に移る
- ユーザーが分析・調査・助言を求めた場合は、調査結果のみを報告する。明示的に指示されない限り、実装計画やコード変更に踏み込まない
- Rust コード変更後は `cargo check -p snotra-core -p snotra` を実行し、コンパイルエラーを解消してから結果を報告する。TypeScript 変更後は `npx vite build` で確認する

## デバッグ・バグ修正

- バグ修正時は、コードを書く前に根本原因を一文で明示する
- 最初の修正案が失敗した場合、同じ深さで別の推測を試みるのではなく、より深い調査に切り替える
- 表層的なパッチの繰り返し（推測→失敗→別の推測）を避け、仮説の検証を優先する
- Win32 関連のバグでは、設定ファイル（`config.toml`）→ ウィンドウライフサイクル順序 → API 呼び出しの順に原因を調査する
- バグ修正時は、修正対象のパターンをコードベース全体で検索し、同一パターンが他の箇所にも存在しないか確認してから完了とする

## パフォーマンス最適化プレイブック

検索/表示の体感遅延を改善するときは、次の順で着手すると最短で効果が出やすい。

1. 待ち時間を潰す（体感改善の即効枠）
   - 入力デバウンス見直し
   - 古い非同期リクエスト結果の破棄（request id / generation）
   - `show` / `setSize` / `setPosition` などウィンドウ操作の不要呼び出し削減
2. 重複処理を消す（低リスク・高効率）
   - 同一データの二重取得（例: アイコン batch 取得）を責務分離して一本化
3. 計算量を下げる（中〜大規模データ向け）
   - 毎回の全件ソートを top-k 抽出へ置換
   - ループ内の再計算（正規化や同一変換）を事前計算へ移動
4. 描画のマイクロ最適化を行う（仕上げ）
   - 文字幅計測や省略文字列生成のキャッシュ
   - 無意味な再スクロール/再レイアウト抑制

### 計測と受け入れ基準

- 変更ごとに「入力 → 検索結果反映」までの遅延を観測し、体感を先に確認する
- 体感改善後、必要なら p50/p95 を追加計測して次のボトルネックを特定する
- 原則として「待ち時間」「重複」「計算量」「描画」の順を崩さない

## 開発原則

### TDD

- 純ロジックモジュール（`snotra-core/src/` 内）は `#[cfg(test)]` でユニットテストを追加する
- Win32 依存モジュール（`src-tauri/src/` 内の `hotkey.rs`, `ime.rs`, `platform.rs`）はユニットテスト前提にしない
- ロジック追加時は、可能な限り `snotra-core` に分離してテスト可能性を維持する

### KISS

- `main.rs` に業務ロジックを増やさない
- `commands.rs` は薄いラッパーに保ち、実処理は `snotra-core` に寄せる
- 責務を跨ぐ実装をしない

### DRY

- 検索スコア計算は `snotra-core/src/search.rs` に集約する
- フォルダ列挙・フィルタ・並び替えは `snotra-core/src/folder.rs` に集約する
- TypeScript 型定義は `ui/src/lib/types.ts` に集約する

### YAGNI

- 使う予定だけの抽象化（不要な trait/generics/レイヤー）を導入しない
- 現在の要求範囲を超える機能追加を行わない
- 拡張性より、現要件での単純さと可読性を優先する

## Win32 / windows クレート開発の注意事項

- `windows` クレート（現在 v0.62）はバージョンごとに API シグネチャが変わる（`Result` 型の有無、ハンドル型の変更など）。コードを書く前に、使用中のバージョンで対象 API が利用可能か・型が一致するかを確認する
- 必要な feature フラグ（`Win32_UI_WindowsAndMessaging` 等）が `Cargo.toml` に宣言されているか確認してから実装する
- Win32 ウィンドウ描画の不具合を調査する際は、コードを疑う前に `config.toml` のテーマ設定やユーザー設定を先に確認する（過去に白画面バグの真因がカスタムテーマ設定だった事例あり）
- `UpdateWindow` など一部 API は windows クレートのバージョンによっては未提供。代替 API（`RedrawWindow` 等）の存在を事前に調べる
- Windows パスの正規化では `C:` と `C:\` の違いに注意する（ドライブルートは末尾 `\` が必須）
- ファイルメタデータ取得時、シンボリックリンクを考慮する場合は `symlink_metadata` を使う（`metadata()` はリンク先を辿る）
- Tauri プラグインの新機能を使う際は `capabilities/*.json` の権限宣言を確認する

## アーキテクチャ概要

Cargo ワークスペース構成で、純ロジックライブラリ（`snotra-core`）と Tauri バイナリ（`src-tauri`）を分離。GUI は SolidJS + CSS 変数ベースのテーマシステムで、Tauri IPC 経由で Rust バックエンドと通信します。各サブディレクトリの `CLAUDE.md` にモジュール詳細を記載。

```
Snotra/
  Cargo.toml              # workspace (snotra-core, src-tauri)
  snotra-core/            # 純ロジック lib crate → snotra-core/CLAUDE.md
  src-tauri/              # Tauri v2 バイナリ crate → src-tauri/CLAUDE.md
  ui/                     # SolidJS フロントエンド → ui/CLAUDE.md
  package.json, vite.config.ts, tsconfig.json
```

### 横断的な実装パターン

- 検索ウィンドウは起動時に作成し `visible: false`、ホットキーで表示/非表示を切替
- フォルダ展開は「開始時スナップショットを保持し、`Escape` で一括復帰」モデル
- 履歴/インデックス/アイコン保存は `.tmp` を使った原子的書き込み
- アイコンは検索時にオンデマンドで抽出し base64 PNG としてフロントエンドに送信、キャッシュは終了時に永続化
- テーマは CSS カスタムプロパティで動的に切替

## 参照先

- 意図（仕様）: `SPEC.md`
- 運用ルール: `CLAUDE.md`（ルート） + 各サブディレクトリの `CLAUDE.md`
- 設定値・デフォルト: `snotra-core/src/config.rs`
