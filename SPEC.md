# Snotra 詳細仕様書

## 0. 本書の役割（意図管理）

- 本書（`SPEC.md`）は「何を実現すべきか」を定義する意図管理ドキュメント
- 実装事実（現在どう動いているか）は `snotra-core/src/*.rs`, `src-tauri/src/*.rs`, `ui/src/**` を参照する
- 実装運用ルール（作業手順・判断基準）は `CLAUDE.md` を参照する

不一致がある場合の原則:

- まず「バグ」か「仕様変更」かを判定する
- バグなら、本書の意図に合わせてコードを修正する
- 仕様変更なら、先に本書を更新してからコードを更新する

## 1. 概要

- Windows専用のコマンドライン型キーボードランチャー
- バックエンドは Rust（Tauri v2）、フロントエンドは SolidJS + TypeScript で構築
- Windows 固有機能（ホットキー/トレイ/IME）は `windows` クレートで直接実装
- システムトレイ常駐型、グローバルホットキーで呼び出し

## 2. インデックスシステム

### 2.1 インデックス対象

- ハードコードされたスキャン対象は存在しない。全て `config.toml` の `paths.scan` で管理
- パスごとに拡張子を個別指定可能
- デフォルトスキャン対象（`Config::default_scan_paths()`）:
  - 共通スタートメニュー（`.lnk`）
  - デスクトップ（`.lnk`）
  - ユーザースタートメニューは含めない
- ユーザーがスキャンパスと対象拡張子の組み合わせを設定可能
  - 例: `C:\Tools` -> `.exe, .bat`, `D:\Docs` -> `.pdf, .xlsx`
- フォルダもエントリとして登録（検索対象）
- 隠し/システム項目はデフォルトで除外し、設定で表示可能

### 2.2 エントリ識別子（重複判定・履歴参照）

- エントリの内部一意キーは `正規化済み絶対パス`
- 以下を同一キーで統一する:
  - インデックス重複判定
  - 検索履歴（グローバル頻度・クエリ別頻度）
  - 起動対象の参照

### 2.3 インデックス構築タイミング

- 初回起動時:
  - 設定ファイル（`config.toml`）不在を初回起動と判定
  - 設定画面をインデックスタブで自動表示し、ユーザーにスキャン対象を確認させる
  - 保存時: 設定保存後に設定ウィンドウを閉じ、バックグラウンドで構築開始
  - 未保存で閉じた場合: デフォルト設定でバックグラウンド構築開始
  - 構築中は検索ウィンドウに「インデックス構築中...」メッセージを表示
  - 構築中はトレイメニューで「インデックス再構築中」表示、設定・終了はグレーアウト
  - 構築完了後、検索ウィンドウは通常モードに復帰
- 通常起動時はハイブリッド方式:
  - 起動時はキャッシュを即時ロード
  - バックグラウンドで差分スキャンを実施
  - 差分があればキャッシュを更新
- 設定画面から手動再構築可能

### 2.4 アイコン

- 検索時にオンデマンドで抽出し、base64 文字列としてキャッシュ・永続化
- `SHGetFileInfoW` → HICON → BGRA → PNG → base64 パイプラインで処理
- `.lnk` -> 対象ショートカット解決結果に対応するアイコン
- その他 -> シェル登録ファイルタイプアイコン
- フォルダ -> フォルダアイコン
- 表示/非表示は設定で切替可能
- フロントエンドでは `<img src="data:image/png;base64,...">` として表示
- アイコンなし時はフォールバック絵文字を表示
- インデックス再構築時はキャッシュをクリア（次回検索時に再抽出）

## 3. 検索システム

### 3.1 検索方式

設定で以下の3種から選択可能（通常時・フォルダ展開時を独立設定）:

- 先頭部分一致: クエリがエントリ名の先頭に一致
- 中間部分一致: クエリがエントリ名の任意位置に一致
- スキップマッチング（ファジー）: `SkimMatcherV2` 相当

### 3.2 クエリ正規化

- クエリ履歴キーは以下で正規化:
  - 前後空白除去（`trim`）
  - 小文字化
  - 連続空白の1文字化

### 3.3 検索結果の優先順位

最終スコア:

`final_score = fuzzy_score + 5 * global_count + 20 * query_count`

- `fuzzy_score`: 選択中検索方式のマッチスコア
- `global_count`: アプリ全体の起動回数
- `query_count`: 同一正規化クエリでの当該項目選択回数
- 履歴スコアの時間減衰は行わない

同点時タイブレーク:

1. `last_launched` 降順（新しいもの優先）
2. `name` 昇順

### 3.4 フォルダ候補の追加ブースト

- フォルダ展開回数ブーストはフォルダ候補にのみ適用
- ファイル候補には適用しない

### 3.5 最大列挙数

- 設定で候補リストの最大表示件数を指定可能（デフォルト: 8）

### 3.6 空クエリ時

- 検索ボックスが空のときは最近実行履歴を `last_launched` 降順で表示

## 4. 履歴・優先度システム

### 4.1 記録内容

- グローバル起動履歴: 項目ごとの総起動回数
- クエリ単位の選択履歴: `(正規化クエリ, 項目ID)` ペア
- フォルダ展開履歴: フォルダの展開回数

### 4.2 データ保存

- バイナリ形式で `%APPDATA%\Snotra\` に保存
- グローバル起動回数の上位N件のみ保存（Nは設定値）
- クエリ単位履歴は上位N件に含まれる項目のみ保持

## 5. フォルダ展開機能

### 5.1 基本動作

- 右カーソルキー:
  - 選択中がフォルダなら、そのフォルダ内容で候補を置換
  - 選択中がファイルなら無反応
- 左カーソルキー:
  - 展開中: 親フォルダ内容で候補を置換（ルート到達時は無反応）
  - 通常検索モード: 無反応

### 5.2 ルート定義

- ローカルドライブ: `C:\` などドライブ直下
- UNC: `\\server\share\` 共有ルート
- 上記を終端として、これ以上の左遷移は行わない

### 5.3 フォルダ展開中の検索

- 文字入力時は現在フォルダ内で絞り込み
- 検索対象は表示名のみ（フルパスは対象外）
- 検索方式は「フォルダ展開時」の設定に従う

### 5.4 フォルダ展開からの復帰

- `Escape` で展開開始前の検索状態に一気に復帰
  - 元の候補一覧
  - 選択位置
  - クエリ文字列

### 5.5 フォルダのEnter操作

- フォルダ選択でEnter: エクスプローラーでそのフォルダを開く
- フォルダ展開操作は右カーソルキーのみ

### 5.6 列挙失敗時

- アクセス拒否などで列挙に失敗した場合:
  - 候補リストに単一のエラー行を表示
  - エラー行でEnterは無効
  - 右/左/Escapeは通常どおり有効

## 6. 設定画面

### 6.1 実装方式

- Tauri v2 の `WebviewWindowBuilder` で同一プロセス内の第2ウィンドウとして生成
- `/o` スラッシュコマンドで開く
- タブ切り替えUI

### 6.2 タブ構成と設定項目

`[全般]` タブ:

- ホットキー（修飾キー + キー）
- 呼び出しキーで表示/非表示トグル
- 起動時にウィンドウ表示するか
- フォーカス喪失時の自動非表示
- タスクトレイアイコン表示切替
- 入力ウィンドウ表示時にIMEをオフ（復元なし）

`[検索]` タブ:

- 通常時検索方式
- フォルダ展開時検索方式
- 最大列挙数
- 隠し/システム項目表示

`[インデックス]` タブ:

- インデックス条件一覧（パス + 拡張子）
  - 追加/編集/削除
- インデックス再構築ボタン
- 履歴保存の上位N件指定
- アイコン表示切替

`[ビジュアル]` タブ:

- プリセットテーマ選択（色 + フォント）
- 背景色、入力欄背景色、テキスト色、選択行色、ヒント文字色
- フォントファミリー、フォントサイズ

### 6.3 設定反映タイミング

- ホットキー: 保存時に `PlatformCommand::SetHotkey` で再登録（失敗時は旧設定維持）
- トレイアイコン: 保存時に `PlatformCommand::SetTrayVisible` で切替
- 検索方式/最大件数: 保存直後に即時反映
- 見た目設定: 保存時に `visual-config-changed` イベントで全ウィンドウの CSS 変数を即時更新
- ウィンドウ幅: 保存時に `set_size` で main/results ウィンドウを即時リサイズ
- インデックス条件（スキャンパス・隠しファイル表示）・アイコン設定:
  - 保存時に変更を検知し、バックグラウンドで自動再構築
  - ステータスに「インデックスを再構築中…」を表示

## 7. ウィンドウ動作

### 7.1 表示/非表示

- ホットキーで表示
- `Escape` で非表示（ただしフォルダ展開中は復帰が優先）
- フォーカス喪失時の自動非表示（`onFocusChanged` イベント、設定で切替、100ms 猶予付き）
- ホットキーでのトグル動作（設定で切替）

### 7.2 ウィンドウ位置

- 検索ウィンドウは検索バーの余白部分（padding 領域）をドラッグして移動可能
- 移動位置をデバウンス保存し次回表示時に復元
- 検索ウィンドウと設定ウィンドウは独立して位置・サイズを記憶
- `window.bin` にバイナリ形式で保存

### 7.3 タイトルバー

- タイトルバーは常に非表示（`tauri.conf.json` の `"decorations": false`）
- `data-tauri-drag-region` による検索バー余白ドラッグで移動

### 7.4 起動時表示制御

- `visible: false` で WebView を作成し、条件付きで `window.show()` を呼ぶ
- `show_on_startup = false` の場合は非表示常駐でホットキー待ち

## 8. 実行履歴メニュー

- 空クエリ時に最近の実行履歴を候補表示
- 表示件数は設定値（実行履歴メニュー最大件数）

## 9. システムトレイ

- Win32 `Shell_NotifyIconW` で実装（`platform.rs` 内）
- トレイアイコン表示は設定で切替
- 右クリックメニュー: 「設定」「終了」
- ダブルクリック: ホットキー相当の表示トグル
- `show_on_startup = true` の起動時は、検索UI（入力欄/結果）を起動直後から表示する
- `show_on_startup = false` の起動時は検索UI（入力欄/結果）を表示しない
- `show_on_startup = false` かつ `show_tray_icon = true` の場合は、可視要素はトレイアイコンのみ
- `show_on_startup = false` かつ `show_tray_icon = false` の場合も非表示常駐し、ホットキー入力で表示可能
- トレイから設定を開くときは検索UIを同時表示せず、設定画面のみ表示する
- ホットキー登録失敗時は操作不能回避のため検索UIを表示する

## 10. ビジュアル

- CSS カスタムプロパティによるテーマシステム
- プリセットテーマ方式（色 + フォント）
- 管理項目:
  - 背景色、入力欄背景色、テキスト色、選択行色、ヒント文字色
  - フォントファミリー、フォントサイズ
- 設定保存時に `document.documentElement.style.setProperty()` で即時反映
- 検索結果はフルパスの1行表示
  - 長いパスは中間セグメントを `...` で省略し、ウィンドウ幅に応じて自動調整
  - フォルダは末尾 `\` で区別

## 11. IME制御

- 設定で有効/無効切替
- 有効時はウィンドウ表示時にIMEをオフ
- 非表示時のIME復元は行わない

## 12. データ保存

### 12.1 設定データ

- `%APPDATA%\Snotra\config.toml`（TOML）
- 欠損キーはデフォルト補完
- 未知キーは無視して読み込み継続

### 12.2 アプリケーションデータ（バイナリ）

用途別ファイル分割:

- `%APPDATA%\Snotra\index.bin`
- `%APPDATA%\Snotra\icons.bin`
- `%APPDATA%\Snotra\history.bin`
- `%APPDATA%\Snotra\window.bin`

共通保存仕様:

- 先頭に `magic + u32 version` ヘッダ
- 保存手順は `tmp書込 -> rename` の原子的置換
- 読み込み失敗（magic/version/deserialize）時は当該ファイルのみ再生成
- 起動時整合性チェックは軽量:
  - ヘッダ検証
  - deserialize可否
  - `index.bin` は config hash 整合性確認

## 13. 実行仕様（起動）

### 13.1 `.lnk` 実行

- `.lnk` はショートカット本体を `ShellExecute` で起動
- ターゲット直接実行への変換は行わない

## 14. スラッシュコマンド

### 14.1 概要

検索ボックスで `/` から始まるテキストを入力すると、スラッシュコマンドとして解釈される。コマンド文字列が完全一致した時点で Enter なしに即実行される。

### 14.2 コマンド一覧

| コマンド | 動作 |
|----------|------|
| `/o` | 設定ウィンドウを開く |
| `/s` | インデックス再構築を開始する |
| `/q` | アプリを終了する |

### 14.3 ヘルプ表示

- `/` のみを入力して停止すると、debounce 後にコマンド一覧が結果エリアに表示される
- 矢印キーで選択し、Enter で実行可能

### 14.4 即実行仕様

- コマンド文字列（例: `/o`）が入力された時点で `createEffect` が発火し、debounce をキャンセルして即座に `action()` を実行する
- 実行後はクエリをクリアし、結果を空にする
- ヘルプ一覧がちらつかない（debounce キャンセルにより `/` 時点の表示が発火する前にコマンドが実行される）

### 14.5 フォルダ展開中の挙動

- フォルダ展開中はスラッシュコマンドを無視し、通常のフォルダフィルタとして処理する

## 15. 非機能要件

- ウィンドウ表示開始まで: 500ms未満（通常起動、WebView2 ウォーム起動）
- 通常検索応答: 30ms未満（キー入力から候補更新）
- Tauri IPC オーバーヘッド: 通常 2ms 未満
- 初回再構築・手動再構築は進捗表示を持つ
