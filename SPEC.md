# Snotra 詳細仕様書

## 1. 概要

- Windows専用のコマンドライン型キーボードランチャー
- 純Rust + Win32 API で構築（GUIフレームワーク不使用）
- システムトレイ常駐型、グローバルホットキーで呼び出し

## 2. インデックスシステム

### 2.1 インデックス対象

- **パスごとに拡張子を個別指定**可能
- デフォルトスキャン対象:
  - ユーザースタートメニュー（.lnk）
  - 共通スタートメニュー（.lnk）
  - デスクトップ（.lnk）
- ユーザーが追加パスと対象拡張子の組み合わせを設定可能
  - 例: `C:\Tools` → `.exe, .bat`, `D:\Docs` → `.pdf, .xlsx`
- **フォルダもエントリとして登録**（検索対象になる）

### 2.2 インデックス構築タイミング

- **初回起動時**にスキャン実行
- **設定画面から手動で再構築**可能
- インデックスデータは**バイナリ形式でキャッシュ**し、次回起動時はキャッシュから読み込み（スキャンスキップ）

### 2.3 アイコン

- インデックス構築時にアイコンを抽出・**バイナリキャッシュ**
- .lnk → ターゲット .exe のアイコン
- その他 → シェル登録のファイルタイプアイコン
- フォルダ → フォルダアイコン
- 表示/非表示は設定で切替可能

## 3. 検索システム

### 3.1 検索方式

設定で以下の3種から選択可能（通常時・フォルダ展開時それぞれ独立に設定）:

- **先頭部分一致**: クエリがエントリ名の先頭に一致
- **中間部分一致**: クエリがエントリ名の任意位置に一致
- **スキップマッチング（ファジー）**: fuzzy-matcher (SkimMatcherV2) と同等

### 3.2 検索結果の優先順位

以下の要素を加味してスコアリング:

1. **グローバル起動頻度**: 検索クエリに関係なく、総起動回数が多いアプリほど上位
2. **クエリ単位の選択履歴**: 同一検索文字列で過去に選択したアプリにブースト
3. **マッチングスコア**: 検索アルゴリズムによるスコア

### 3.3 最大列挙数

- 設定で候補リストの最大表示件数を指定可能（デフォルト: 8）

## 4. 履歴・優先度システム

### 4.1 記録内容

- **グローバル起動履歴**: アプリごとの総起動回数
- **クエリ単位の選択履歴**: (クエリ文字列, 選択アプリ) のペア
- **フォルダ展開履歴**: フォルダの展開回数（フォルダの検索順位に影響）

### 4.2 データ保存

- **バイナリ形式**で `%APPDATA%\Snotra\` に保存
- グローバル起動回数の**上位N件のみ保存**（Nは設定で指定可能）
- クエリ単位の履歴は上位N件に含まれるアプリのみ保持

## 5. フォルダ展開機能

### 5.1 基本動作

- **右カーソルキー**: 選択中アイテムがフォルダの場合、そのフォルダの中身で候補リストを**置換**
- **左カーソルキー**: 現在表示中のフォルダの親フォルダの中身で候補リストを置換
- 選択中アイテムがファイルの場合、右キーは**無反応**
- ルート（ドライブ直下）に達している場合、左キーは**無反応**

### 5.2 フォルダ展開中の検索

- フォルダ展開中に文字を入力すると、**そのフォルダ内での絞り込み検索**になる
- 検索方式は「フォルダ展開時」の設定に従う

### 5.3 フォルダ展開からの復帰

- **Escapeキー**で元の検索結果に復帰

### 5.4 フォルダのEnter操作

- フォルダを選択してEnterを押すと、**エクスプローラーでそのフォルダを開く**
- フォルダ展開は右カーソルキーのみ

### 5.5 フォルダ優先度

- フォルダを展開するたびに展開回数を記録
- よく展開されるフォルダは、検索でフォルダ名を入力した際に**上位に表示**される

## 6. 設定画面

### 6.1 実装方式

- **Win32ダイアログ**として実装
- `/o` コマンドで開く（検索ボックスに `/o` と入力してEnter）
- **タブ切り替え**による分類

### 6.2 タブ構成と設定項目

**[全般] タブ:**

- ホットキー（修飾キー + キーの組み合わせ）
- 呼び出しキーで表示/非表示のトグル切り替え（有効/無効）
- 起動時にウィンドウを表示するかどうか
- フォーカスが外れたら自動で非表示にする
- タスクトレイアイコンの表示切替
- 入力ウィンドウ表示時にIMEをオフにする（表示時にオフのみ、復元なし）
- タイトルバー表示・非表示切替

**[検索] タブ:**

- 通常時の検索方式: 先頭一致 / 中間一致 / スキップマッチング
- フォルダ展開時の検索方式: 先頭一致 / 中間一致 / スキップマッチング
- 最大列挙数

**[インデックス] タブ:**

- インデックス条件の一覧（パス + 拡張子リスト）
  - 追加・編集・削除操作
- インデックス再構築ボタン
- 順位保存の上位N件指定
- アイコン表示切替

**[ビジュアル] タブ:**

- プリセットテーマ選択（色 + フォントを含む）
- テーマに含まれる色:
  - 背景色
  - 入力欄背景色
  - テキスト色
  - 選択行色
  - ヒント文字色
- テーマに含まれるフォント: フォントファミリー、サイズ

## 7. ウィンドウ動作

### 7.1 表示/非表示

- ホットキーで表示
- Escapeで非表示（フォルダ展開中の場合は展開解除が優先）
- フォーカス喪失時の自動非表示（設定で切替可能）
- ホットキーによるトグル動作（設定で切替可能）

### 7.2 ウィンドウ位置

- ドラッグで移動した位置を**記憶**し、次回表示時も同じ位置に表示
- タイトルバー表示時はドラッグで移動可能
- タイトルバー非表示時もウィンドウ位置は記憶された位置を使用

### 7.3 タイトルバー

- 設定でタイトルバーの表示/非表示を切替可能
- 非表示時は現在と同じフレームレス（WS_POPUP）

## 8. 実行履歴メニュー

- 検索ボックスが空の状態で、候補リストに**最近の実行履歴**を表示
- 表示件数は設定で指定可能（実行履歴メニューの最大アイテム数）

## 9. システムトレイ

- トレイアイコンの表示/非表示を設定で切替可能
- 右クリックメニュー: 終了

## 10. ビジュアル

- **プリセットテーマ**方式（色 + フォントのセット）
- テーマで管理する項目:
  - 背景色、入力欄背景色、テキスト色、選択行色、ヒント文字色
  - フォントファミリー、フォントサイズ

## 11. IME制御

- 設定で有効/無効を切替可能
- 有効時: 検索ウィンドウ表示時にIMEをオフ（英字入力モード）にする
- ウィンドウ非表示時のIME復元は行わない

## 12. データ保存

### 12.1 設定データ

- `%APPDATA%\Snotra\config.toml`（TOML形式）

### 12.2 アプリケーションデータ（バイナリ形式）

- `%APPDATA%\Snotra\` 配下に保存
- インデックスキャッシュ（ファイルパス一覧 + アイコンデータ）
- 起動履歴（グローバル頻度 + クエリ単位履歴）
- フォルダ展開履歴
- ウィンドウ位置

## 13. 実装フェーズ

### Phase 1: 履歴・優先度システム

- 起動履歴記録（グローバル頻度 + クエリ単位）
- 検索結果の優先順位反映
- バイナリ永続化
- 空文字列時の実行履歴表示

### Phase 2: フォルダ展開機能

- 左右カーソルキーによるフォルダナビゲーション
- フォルダ展開中の絞り込み検索
- フォルダ優先度記録
- Escapeで元の検索結果に復帰

### Phase 3: インデックス拡張

- 任意拡張子対応（パスごとの拡張子指定）
- フォルダのエントリ登録
- アイコン抽出・キャッシュ
- インデックスのバイナリキャッシュ

### Phase 4: 検索方式拡張

- 先頭一致・中間一致・スキップマッチングの3方式実装
- 通常時・フォルダ展開時の独立設定

### Phase 5: 設定画面

- Win32ダイアログ実装
- タブ切り替えUI
- /o コマンドによる起動
- 全設定項目の編集機能

### Phase 6: ビジュアル・その他

- プリセットテーマシステム
- IME制御
- ホットキートグル動作
- タイトルバー表示切替
- ウィンドウ位置記憶
- タスクトレイアイコン表示切替
